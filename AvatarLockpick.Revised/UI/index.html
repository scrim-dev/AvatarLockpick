<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvatarLockpick</title>
    <!-- IMPORTANT: Add an icon library like Font Awesome here -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="AppStyle.css" />
    <!-- Add any required font imports here, e.g., Google Fonts -->
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <h1 class="app-title">
                <!-- Wrap each character in a span with calculated delay -->
                <span style="--delay: 0.0s">A</span><span style="--delay: 0.05s">v</span><span style="--delay: 0.1s">a</span><span style="--delay: 0.15s">t</span><span style="--delay: 0.2s">a</span><span style="--delay: 0.25s">r</span><span style="--delay: 0.3s">L</span><span style="--delay: 0.35s">o</span><span style="--delay: 0.4s">c</span><span style="--delay: 0.45s">k</span><span style="--delay: 0.5s">p</span><span style="--delay: 0.55s">i</span><span style="--delay: 0.6s">c</span><span style="--delay: 0.65s">k</span>
            </h1>
            <div id="splash-spinner"></div>
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" aria-label="Toggle Sidebar"><i class="fa-solid fa-bars"></i></button>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" style="display: none;"> <!-- Initially hidden -->
        <nav class="sidebar">
            <ul>
                <!-- Replaced text with icons and added aria-label for tooltip -->
                <li><button class="tab-button active" data-tab="avatar" aria-label="Avatar"><i class="fa-solid fa-user"></i><span class="tab-text">Avatar</span></button></li>
                <li><button class="tab-button" data-tab="unlock" aria-label="Unlock"><i class="fa-solid fa-lock-open"></i><span class="tab-text">Unlock</span></button></li>
                <li><button class="tab-button" data-tab="recents" aria-label="Recents"><i class="fa-solid fa-history"></i><span class="tab-text">Recents</span></button></li>
                <li><button class="tab-button" data-tab="logs" aria-label="Logs"><i class="fa-solid fa-file-lines"></i><span class="tab-text">Logs</span></button></li>
                <li><button class="tab-button" data-tab="settings" aria-label="Settings"><i class="fa-solid fa-gear"></i><span class="tab-text">Settings</span></button></li>
                <li><button class="tab-button" data-tab="info" aria-label="Info"><i class="fa-solid fa-circle-info"></i><span class="tab-text">Info</span></button></li>
            </ul>
        </nav>

        <main class="content">
            <!-- Tab Panels -->
            <div id="avatar-tab" class="tab-panel active">
                 <h2><i class="fa-solid fa-user"></i> Avatar</h2>
                 <div class="tab-content-panel">
                     <label for="avatar-id">Avatar ID</label>
                     <input type="text" id="avatar-id" name="avatar-id" placeholder="avtr_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

                     <label for="user-id">User ID</label>
                     <input type="text" id="user-id" name="user-id" placeholder="usr_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

                     <div class="checkbox-container">
                        <input type="checkbox" id="censor-user-id">
                        <label for="censor-user-id">Censor User ID</label>
                     </div>

                     <button class="action-button" onclick="callDotNetSendIDs()"><i class="fa-solid fa-eye"></i> View Avatar</button>
                     <button class="action-button" onclick="loadAvatarInfo()"><i class="fa-solid fa-download"></i> Load Avatar</button>
                     <button class="action-button secondary-action" onclick="clearInputFields()"><i class="fa-solid fa-eraser"></i> Clear Fields</button>
                 </div>
            </div>

            <div id="unlock-tab" class="tab-panel">
                <h2><i class="fa-solid fa-lock-open"></i> Unlock Actions</h2>
                <!-- Warning Panel -->
                <div id="unlock-warning-panel" class="tab-content-panel warning-panel" style="display: block;"> <!-- Initially visible -->
                    <p><i class="fa-solid fa-triangle-exclamation"></i> Please load an avatar from the Avatar tab first.</p>
                </div>
                 <div class="tab-content-panel">
                     <!-- Buttons for unlock actions -->
                     <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn" onclick="triggerPopup('Unlock')" disabled><i class="fa-solid fa-unlock"></i> Unlock</button>
                        <p class="unlock-action-description">Will use the general unlock method to unlock avatars.</p>
                     </div>
                     <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn" onclick="triggerPopup('Unlock (VRCFury)')" disabled><i class="fa-solid fa-bolt"></i> Unlock (VRCFury)</button>
                        <p class="unlock-action-description">Will attempt to unlock VRCFury parameters.</p>
                    </div>
                     <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn" onclick="triggerPopup('Database Unlock')" disabled><i class="fa-solid fa-database"></i> Database Unlock</button>
                        <p class="unlock-action-description">Scans avatar's locks against a database of parameters to find a match and unlock.</p>
                    </div>
                     <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn beta-btn" onclick="triggerPopup('Beta Database Unlock')" disabled><i class="fa-solid fa-flask"></i> Beta Database Unlock</button>
                        <p class="unlock-action-description">Uses the new SQL-based lock database for improved matching. <span class="beta-tag">BETA</span></p>
                    </div>
                     <!-- Info Badge -->
                     <div class="info-badge">
                        <i class="fa-solid fa-circle-info"></i>
                        <p><strong>Database Migration Notice:</strong> I'm transitioning from a text-based lock database (.txt) to a proper SQL database (.db) for better performance and reliability. You can test the new system using the <em>Beta Database Unlock</em> function above. Check the <strong>Settings</strong> tab to load your own custom database via URL or file path.</p>
                     </div>
                     <!-- New Restart Buttons -->
                     <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn" onclick="triggerRestart('restart-novr')" disabled><i class="fa-solid fa-arrows-rotate"></i> Restart</button>
                        <p class="unlock-action-description">Restarts VRChat.</p>
                    </div>
                    <div class="unlock-action-container">
                        <button class="action-button unlock-action-btn" onclick="triggerRestart('restart-vr')" disabled><i class="fa-solid fa-arrows-rotate"></i> Restart (VR)</button>
                        <p class="unlock-action-description">Restarts VRChat in VR mode.</p>
                    </div>
                 </div>
                 <div id="loaded-avatar-info-panel" class="tab-content-panel" style="display: none;">
                    <h3>Loaded Avatar</h3>
                    <p><strong>Avatar ID:</strong> <span id="loaded-avatar-id">N/A</span></p>
                    <p><strong>User ID:</strong> <span id="loaded-user-id">N/A</span></p>
                    <button class="action-button secondary-action" onclick="showUnloadConfirmation()"><i class="fa-solid fa-times-circle"></i> Unload Avatar</button>
                 </div>
            </div>

            <div id="recents-tab" class="tab-panel">
                <h2><i class="fa-solid fa-history"></i> Recents</h2>
                <div class="tab-content-panel">
                    <h3>History</h3>
                    <div id="history-list-container">
                        <!-- History items will be populated here by JavaScript -->
                        <p id="no-history-message">No recent avatars loaded. Load an avatar in the 'Avatar' tab to see it here.</p>
                    </div>
                </div>
                <div class="tab-content-panel">
                    <h3>Manage History</h3>
                    <button class="action-button" onclick="exportHistory()"><i class="fa-solid fa-file-export"></i> Export as JSON</button>
                    <button class="action-button" onclick="showImportPopup()"><i class="fa-solid fa-file-import"></i> Import from JSON</button>
                </div>
            </div>

            <div id="logs-tab" class="tab-panel">
                <h2><i class="fa-solid fa-file-lines"></i> Application Logs</h2>
                <div class="tab-content-panel logs-panel">
                    <div id="app-logs-container">
                        <!-- Logs will appear here -->
                        <div class="log-entry"><span class="log-system">[System]</span> Waiting for logs...</div>
                    </div>
                    <div class="logs-actions">
                         <button class="action-button secondary-action" onclick="clearAppLogs()"><i class="fa-solid fa-trash"></i> Clear Logs</button>
                         <button class="action-button" onclick="copyAppLogs()"><i class="fa-solid fa-copy"></i> Copy to Clipboard</button>
                    </div>
                </div>
            </div>

            <div id="settings-tab" class="tab-panel">
                <h2><i class="fa-solid fa-gear"></i> Settings</h2>
                 <div class="tab-content-panel">
                     <h3>Theme Customization</h3>
                     <div class="setting-option">
                         <h4>Presets</h4>
                         <div class="preset-buttons">
                             <button class="action-button preset-btn" data-preset="crimson" style="--preset-bg: #DC143C;">Crimson</button>
                             <button class="action-button preset-btn" data-preset="green" style="--preset-bg: #2ECC71;">Green</button>
                             <button class="action-button preset-btn" data-preset="magenta" style="--preset-bg: #DE3BFF;">Magenta</button>
                             <button class="action-button preset-btn" data-preset="dodgerblue" style="--preset-bg: #1E90FF;">Default (Blue)</button>
                         </div>
                         <hr style="border-color: var(--border-color); margin: 1em 0;">
                         <h4>Custom Colors</h4>
                         <div class="color-picker-container">
                            <label for="bg-color-picker">Background Color:</label>
                            <input type="color" id="bg-color-picker" data-var="--bg-color">
                         </div>
                         <div class="color-picker-container">
                            <label for="panel-color-picker">Panel/Secondary BG:</label>
                            <input type="color" id="panel-color-picker" data-var="--panel-bg-color">
                         </div>
                           <div class="color-picker-container">
                            <label for="text-color-picker">Text Color:</label>
                            <input type="color" id="text-color-picker" data-var="--text-color">
                         </div>
                         <div class="color-picker-container">
                            <label for="accent-color-picker">Accent Color:</label>
                            <input type="color" id="accent-color-picker" data-var="--accent-color">
                         </div>
                         <div class="color-picker-container">
                            <label for="accent-hover-color-picker">Accent Hover Color:</label>
                            <input type="color" id="accent-hover-color-picker" data-var="--accent-hover-color">
                         </div>
                          <button class="action-button" onclick="resetTheme()"><i class="fa-solid fa-rotate-left"></i> Reset Theme</button>
                     </div>
                     <h3>Preferences</h3>
                    <div class="setting-option">
                         <div class="checkbox-container">
                             <input type="checkbox" id="animations-toggle" checked>
                             <label for="animations-toggle">Enable UI Animations</label>
                        </div>
                         <div class="checkbox-container">
                             <input type="checkbox" id="backend-messages-toggle">
                             <label for="backend-messages-toggle">Show Backend Communication Popups</label>
                        </div>
                    </div>
                    <h3>Custom Database</h3>
                    <div class="setting-option">
                        <p>Load your own lock database from a URL or local file path. Leave empty to use the default database.</p>
                        <label for="custom-db-url">Database URL</label>
                        <input type="text" id="custom-db-url" placeholder="https://example.com/my_locks.db">
                        <label for="custom-db-path">Or Local File Path</label>
                        <input type="text" id="custom-db-path" placeholder="C:\path\to\my_locks.db">
                        <button class="action-button" onclick="saveCustomDbSettings()"><i class="fa-solid fa-save"></i> Save Database Settings</button>
                        <button class="action-button secondary-action" onclick="resetCustomDbSettings()"><i class="fa-solid fa-rotate-left"></i> Reset to Default</button>
                    </div>
                    <h3>Advanced</h3>
                    <div class="setting-option">
                        <p>Clearing cache will reset theme settings, sidebar state, and User ID censor preference stored in your browser for this GUI.</p>
                        <button class="action-button secondary-action" onclick="clearCacheAndReload()"><i class="fa-solid fa-trash-can"></i> Clear Cache & Reload GUI</button>
                    </div>
                 </div>
            </div>

            <div id="info-tab" class="tab-panel">
                <h2><i class="fa-solid fa-circle-info"></i> Info</h2>
                <div class="tab-content-panel">
                    <p>AvatarLockpick App</p>
                    <p>GUI made with Photino.NET</p>
                    <p>Developed by Scrimmane / ScrimDev</p>
                    <p>App Icon by Kmg Design</p>
                    <hr style="border-color: var(--border-color); margin: 1.5em 0;">
                    <button class="action-button" onclick="showNetResponsePopup()"><i class="fa-solid fa-terminal"></i> View .NET Log</button>
                    <p><strong>Note:</strong> You can customize this interface! Feel free to edit the files in the application's 'UI' folder to create your own look.</p>
                    <button class="action-button" onclick="openHelpUrl()"><i class="fa-solid fa-question-circle"></i> Help Page</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Basic Popup Placeholder -->
    <div id="action-popup" class="popup">
        <h3 id="popup-title">Action Triggered</h3>
        <p id="popup-message">Placeholder message for the action.</p>
        <div class="popup-buttons">
            <button class="action-button" onclick="closePopup()">Close</button>
        </div>
    </div>

    <!-- Confirmation Popup for Unloading -->
    <div id="confirm-unload-popup" class="popup confirmation-popup">
        <h3 id="confirm-popup-title">Unload Avatar?</h3>
        <p id="confirm-popup-message">Are you sure you want to unload the current avatar information?</p>
        <div class="popup-buttons">
            <button class="action-button primary-action" onclick="confirmUnloadAvatar()">Yes, Unload</button>
            <button class="action-button secondary-action" onclick="cancelUnloadAvatar()">Cancel</button>
        </div>
    </div>

    <!-- Note Editor Popup -->
    <div id="note-popup" class="popup">
        <h3><i class="fa-solid fa-note-sticky"></i> Edit Note</h3>
        <p>Add or edit your note for the avatar below.</p>
        <textarea id="note-textarea" placeholder="e.g., 'Cool robot avatar with glowing bits'"></textarea>
        <div class="popup-buttons">
            <button class="action-button" onclick="saveNote()">Save Note</button>
            <button class="action-button secondary-action" onclick="closeNotePopup()">Cancel</button>
        </div>
    </div>

    <!-- .NET Response Popup -->
    <div id="net-response-popup" class="popup">
        <h3><i class="fa-solid fa-terminal"></i> .NET Log</h3>
        <pre id="net-response-content">Waiting for messages from .NET...</pre>
        <div class="popup-buttons">
            <button class="action-button" onclick="closeNetResponsePopup()">Close</button>
            <button class="action-button secondary-action" onclick="clearNetLog()">Clear Log</button>
        </div>
    </div>

    <!-- Import JSON Popup -->
    <div id="import-json-popup" class="popup">
        <h3>Import History from JSON</h3>
        <p>Paste your JSON content below. This will overwrite your current history.</p>
        <textarea id="import-json-textarea" placeholder='[{"avatarId":"avtr_...","userId":"usr_...","timestamp":...}]'></textarea>
        <div id="import-error-message" style="color: #DC143C; margin-top: 10px; display: none;"></div>
        <div class="popup-buttons">
            <button class="action-button" onclick="importHistory()">Import</button>
            <button class="action-button secondary-action" onclick="closeImportPopup()">Cancel</button>
        </div>
    </div>

    <!-- Unlock Tab Notice Popup -->
    <div id="unlock-notice-popup" class="popup notice-popup">
        <h3><i class="fa-solid fa-info-circle"></i> Notice</h3>
        <p>The 'Unlock using Database' feature scans the avatar file against a database of known lock signatures. This can help unlock avatars even if the locking components are hidden, renamed, or scrambled.</p>
        <div class="popup-timer">Closing in <span id="notice-timer">10</span>s...</div>
        <button onclick="closeUnlockNotice()">Close</button>
    </div>

    <!-- Download Progress Popup -->
    <div id="download-progress-popup" class="popup">
        <h3><i class="fa-solid fa-download"></i> <span id="download-title">Downloading Database...</span></h3>
        <div class="spinner-container">
            <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
        </div>
        <p id="download-status">Preparing download...</p>
    </div>

    <!-- Keep the Photino communication script -->
    <script src="app://dynamic.js"></script>
    <!-- External script for all application logic -->
    <script src="AppScript.js"></script>
</body>
</html>